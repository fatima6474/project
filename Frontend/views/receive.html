<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: flex;
            height: 100vh; /* Set the height of the body to 100% of the viewport height */
            overflow: hidden;
        }
        .user-message {
    align-self: flex-end;
    background-color: #4CAF50;
    color: #fff;
    border-radius: 10px;
    padding: 10px;
    max-width: 70%;
    word-wrap: break-word;
}

.talent-message {
    align-self: flex-start;
    background-color: #ddd;
    color: #333;
    border-radius: 10px;
    padding: 10px;
    max-width: 70%;
    word-wrap: break-word;
}

        #chatContainer {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #chatList {
            width: 20%;
            background-color: #ddd;
            padding: 20px;
            overflow-y: scroll;
        }
        .notification {
    position: fixed;
    top: 10px;
    right: 10px;
    background-color: #4CAF50;
    color: #fff;
    padding: 10px;
    border-radius: 5px;
    z-index: 999;
    transition: opacity 0.3s ease;
}

.notification:hover {
    opacity: 0.8;
}

        #chatContent {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #messageContainer {
            flex: 1;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            overflow-y: scroll;
            position: relative;
        }
        sender-email {
            width: 100%;
            background-color: #4CAF50;
            color: #671b1b;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .message {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        .user-message {
            align-self: flex-start;
            background-color: #4CAF50;
            color: #fff;
            border-radius: 10px;
            padding: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }
/* Add this to your existing styles or create a new CSS file */
.sender-email {
    width: 100%;
    background-color: #4CAF50;
    color: #fff;
    padding: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s ease; /* Add a smooth transition effect */
}

.sender-email:hover {
    background-color: #45a049; /* Change the background color on hover */
}

        .talent-message {
            align-self: flex-end;
            background-color: #ddd;
            color: #333;
            border-radius: 10px;
            padding: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }

        /* Rest of your styles... */

        #inputContainer {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #ddd;
            border-radius: 10px;
            margin-top: 10px;
        }

        #inputMessage {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            margin-right: 10px;
        }

        #sendBtn {
            background-color: #4CAF50;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f4f4;
}

#chatList {
    max-width: 600px;
    margin: 20px auto;
    background-color: #fff;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

#chatList p {
    margin: 0;
    padding: 5px;
    border-bottom: 1px solid #ddd;
}

#chatList p:last-child {
    border-bottom: none;
}

/* Add more styling as needed */

    </style>
</head>

<body>
    <div id="chatContainer">
        <div id="chatList">
            <!-- Sender emails will be displayed here dynamically -->
        </div>

        <!-- Wrap messages and input container in a parent container -->
        <div id="chatContent">
            <div id="messageContainer">
                <!-- Messages will be displayed here dynamically -->
            </div>
<!-- Add this container where you want to display job details -->
<div id="jobDetailsContainer"></div>

            <!-- Add textarea, icons, and send button below the messages -->
            <div id="inputContainer">
                <textarea id="inputMessage" placeholder="Type your message..."></textarea>
                <!-- Add your icons here if needed -->
                <!-- Modify the button element in your HTML -->
<button id="sendBtn" onclick="sendMessage()">Send</button>

            </div>
        </div>
    </div>
    <!-- Add this script tag to include Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
       
       document.addEventListener("DOMContentLoaded", function () {
    const queryParams = new URLSearchParams(window.location.search);
    const receiverEmail = queryParams.get("email");
    const senderEmail = queryParams.get("senderEmail");
    const jobDescription = queryParams.get("jobDescription");

    // Display the relevant information in your chatlist (you need to implement this)
    // displayConversationInfo(receiverEmail, jobDescription);

    // Fetch and display messages for the specified conversation
    fetchAndDisplayMessages(receiverEmail, senderEmail, jobDescription);
});

// ...

async function fetchAndDisplayMessages(receiverEmail, senderEmail, jobDescription) {
    try {
        // Fetch messages from the server based on the conversation parameters
        const response = await fetch(`http://127.0.0.1:305/fetchMessagesForConversation?receiverEmail=${receiverEmail}&senderEmail=${senderEmail}&jobDescription=${jobDescription}`);

        if (!response.ok) {
            throw new Error(`Error fetching messages: ${response.statusText}`);
        }

        const responseData = await response.json();
        const receivedMessages = responseData.messages;

        console.log("Received Messages:", receivedMessages);

        // Display the received messages in your chatlist
        // Implement your logic to display messages in the chatlist
    } catch (error) {
        console.error("Error fetching messages:", error);
    }
}

// ...

async function fetchSenderEmails() {
    try {
        const parsedData = JSON.parse(localStorage.getItem("formData"));

        if (!parsedData) {
            console.error("User data not found in local storage.");
            return;
        }

        const loggedInUserEmail = parsedData.email;

        const response = await fetch("http://127.0.0.1:305/fetchSenderEmails");

        if (!response.ok) {
            throw new Error(`Error fetching sender emails: ${response.statusText}`);
        }

        const responseData = await response.json();

        // console.log("Raw Sender Emails Data:", responseData);

        if (Array.isArray(responseData.senderEmails)) {
            // console.log("Fetched Sender Emails:", responseData.senderEmails);

            // Filter the sender emails to include only the logged-in user's email
            const relevantSenderEmails = responseData.senderEmails.filter(email => email !== loggedInUserEmail);

            // Display relevant sender emails
            displaySenderEmails(relevantSenderEmails);
        } else {
            throw new Error("Invalid data format received for sender emails.");
        }
    } catch (error) {
        console.error("Error fetching sender emails:", error);
    }
}

        // Function to display sender emails in the chat list
        function displaySenderEmails(senderEmails) {
            const chatList = document.getElementById("chatList");
    
            // Clear existing sender emails in the chat list
            chatList.innerHTML = "";
    
            senderEmails.forEach((senderEmail) => {
                const senderEmailElement = document.createElement("div");
                senderEmailElement.classList.add("sender-email");
                senderEmailElement.textContent = senderEmail;
    
                // Add click event listener to each sender email element
                senderEmailElement.addEventListener("click", function () {
                    // Remove the "selected" class from all sender elements
                    document.querySelectorAll(".sender-email").forEach((element) => {
                        element.classList.remove("selected");
                    });
    
                    // Add the "selected" class to the clicked sender element
                    senderEmailElement.classList.add("selected");
    
                    // Display messages and job details when sender's email is clicked
                    const receiverEmail = senderEmailElement.textContent;
                    loadMessages(receiverEmail);
                    fetchJobDetails(receiverEmail).then((jobDetails) => {
                        displayJobDetails(jobDetails);
                    });
                });
    
                chatList.appendChild(senderEmailElement);
            });
        }
    
        // Function to fetch job details based on job description
        async function fetchJobDetails(jobDescription) {
            try {
                const response = await fetch(`http://127.0.0.1:305/fetchJobDetails?jobDescription=${jobDescription}`);
    
                if (!response.ok) {
                    throw new Error(`Error fetching job details: ${response.statusText}`);
                }
    
                const responseData = await response.json();
    
                // console.log("Raw Job Details Data:", responseData);
    
                if (responseData.jobDetails) {
                    console.log("Fetched Job Details:", responseData.jobDetails);
                    return responseData.jobDetails;
                } else {
                    throw new Error("Invalid data format received for job details.");
                }
            } catch (error) {
                console.error("Error fetching job details:", error);
                return null;
            }
        }
    
        // Function to display job details
        function displayJobDetails(jobDetails) {
            const jobDetailsContainer = document.getElementById("jobDetailsContainer");
            jobDetailsContainer.innerHTML = `<p>Job Title: ${jobDetails.job_title}</p><p>Description: ${jobDetails.job_description}</p>`;
        }
    
        // Function to fetch receiver messages based on receiver's email
        async function fetchReceiverMessages(receiverEmail) {
            try {
                const response = await fetch(`http://127.0.0.1:305/fetchReceiverMessages?receiverEmail=${receiverEmail}`);
    
                if (!response.ok) {
                    throw new Error(`Error fetching receiver messages: ${response.statusText}`);
                }
    
                const responseData = await response.json();
    
                // console.log("Raw Receiver Messages Data:", responseData);
    
                if (Array.isArray(responseData.messages)) {
                    console.log("Fetched Receiver Messages:", responseData.messages);
                    return responseData.messages;
                } else {
                    throw new Error("Invalid data format received for receiver messages.");
                }
            } catch (error) {
                console.error("Error fetching receiver messages:", error);
                return [];
            }
        }
    
// Modify the displayReceiverMessages function to fetch and display sent messages
function displayReceiverMessages(receiverMessages, loggedInUserEmail) {
    const messagesContainer = document.getElementById("messageContainer");
    messagesContainer.innerHTML = ""; // Clear existing messages

    // Display received messages
    receiverMessages.forEach((message, index) => {
        const messageContainer = document.createElement("div");
        messageContainer.classList.add("message");
        messageContainer.id = `message_${index + 1}`;

        const textElement = document.createElement("p");
        textElement.textContent = `Text: ${message.text}`;

        const timestampElement = document.createElement("p");
        timestampElement.textContent = `Timestamp: ${message.timestamp}`;

        if (message.senderEmail === loggedInUserEmail) {
            // If the message is sent by the logged-in user, apply user-message style
            messageContainer.classList.add("user-message");
        } else {
            // If the message is received, apply talent-message style
            messageContainer.classList.add("talent-message");
        }

        messageContainer.appendChild(textElement);
        messageContainer.appendChild(timestampElement);

        messagesContainer.appendChild(messageContainer);
    });

    // Fetch and display sent messages
    fetchSentMessages(loggedInUserEmail).then((sentMessages) => {
        displaySentMessages(sentMessages);
    });
}
function displaySentMessage(message) {
    const messagesContainer = document.getElementById("messageContainer");

    const sentMessageContainer = document.createElement("div");
    sentMessageContainer.classList.add("message", "user-message");
    sentMessageContainer.innerHTML = `<p>Text: ${message.text}</p><p>Timestamp: ${getCurrentTimestamp()}</p>`;

    messagesContainer.appendChild(sentMessageContainer);
}

function displayReceiverMessages(receiverMessages, loggedInUserEmail) {
    const messagesContainer = document.getElementById("messageContainer");
    messagesContainer.innerHTML = ""; // Clear existing messages

    // Display both sent and received messages
    receiverMessages.forEach((message, index) => {
        const messageContainer = document.createElement("div");
        messageContainer.classList.add("message");
        messageContainer.id = `message_${index + 1}`;

        const textElement = document.createElement("p");
        textElement.textContent = `Text: ${message.text}`;

        const timestampElement = document.createElement("p");
        timestampElement.textContent = `Timestamp: ${message.timestamp}`;

        if (message.senderEmail === loggedInUserEmail) {
            // If the message is sent by the logged-in user, apply user-message style
            messageContainer.classList.add("user-message");
        } else {
            // If the message is received, apply talent-message style
            messageContainer.classList.add("talent-message");
        }

        messageContainer.appendChild(textElement);
        messageContainer.appendChild(timestampElement);

        messagesContainer.appendChild(messageContainer);
    });

    // Fetch and display sent messages
    fetchSentMessages(loggedInUserEmail).then((sentMessages) => {
        // Display sent messages with user-message style
        sentMessages.forEach((sentMessage) => {
            const sentMessageContainer = document.createElement("div");
            sentMessageContainer.classList.add("message", "user-message");
            sentMessageContainer.innerHTML = `<p>Text: ${sentMessage.text}</p><p>Timestamp: ${getCurrentTimestamp()}</p>`;

            messagesContainer.appendChild(sentMessageContainer);
        });
    });
}


function getCurrentTimestamp() {
    const now = new Date();
    return now.toLocaleString();
}

    
        // Function to load messages for the selected receiver email
        function loadMessages(receiverEmail) {
            fetchReceiverMessages(receiverEmail).then((receiverMessages) => {
                displayReceiverMessages(receiverMessages);
            });
        }
    
        // Function to fetch and display messages for the logged-in user
        async function fetchMessagesForLoggedInUser(email) {
            try {
                const response = await fetch(`http://127.0.0.1:305/fetchReceiverMessages?receiverEmail=${email}`);
    
                if (!response.ok) {
                    throw new Error(`Error fetching messages: ${response.statusText}`);
                }
    
                const responseData = await response.json();
    
                // console.log("Raw Response Data:", responseData);
    
                if (responseData.messages) {
                    // console.log("Fetched Messages:", responseData.messages);
                    displayReceiverMessages(responseData.messages);
                } else {
                    throw new Error("Invalid data format received from the server.");
                }
            } catch (error) {
                console.error("Error fetching messages:", error);
            }
        }
    
        // Event listener when the DOM content is loaded
        document.addEventListener("DOMContentLoaded", async function () {
            const parsedData = JSON.parse(localStorage.getItem("formData"));
    
            if (parsedData) {
                const loggedInUserEmail = parsedData.email;
    
                // Fetch and display messages for the logged-in user
                await fetchMessagesForLoggedInUser(loggedInUserEmail);
    
                // Fetch and display sender emails for the chat list
                await fetchSenderEmails();
            } else {
                console.error("User data not found in local storage.");
            }
        });
    
       // Function to send a message

       async function sendMessage() {
    try {
        const inputMessage = document.getElementById("inputMessage");
        const messageText = inputMessage.value.trim();

        if (messageText === "") {
            alert("Please enter a message before sending.");
            return;
        }

        const parsedData = JSON.parse(localStorage.getItem("formData"));

        if (!parsedData) {
            console.error("User data not found in local storage.");
            return;
        }

        const senderEmail = parsedData.email;

        // Get the selected receiverEmail from the chat list
        const selectedSenderElement = document.querySelector(".sender-email.selected");
        if (!selectedSenderElement) {
            console.error("No sender selected.");
            return;
        }

        const receiverEmail = selectedSenderElement.textContent;

        const response = await fetch("http://127.0.0.1:305/api/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                senderEmail,
                receiverEmail,
                text: messageText,
            }),
        });

        if (response.ok) {
            // Emit a message event to the server using Socket.IO
            socket.emit("message", {
                senderEmail,
                receiverEmail,
                text: messageText,
            });

            // Notification for successful message sent
            displayNotification("Message sent successfully!");

            // Clear the textarea
            inputMessage.value = "";

            // Display the sent message
            displaySentMessage({
                senderEmail,
                text: messageText,
            });
        } else {
            throw new Error(`Error sending message: ${response.statusText}`);
        }
    } catch (error) {
        console.error("Error sending message:", error);
    }
}


// Function to display a notification
function displayNotification(message) {
    const notificationContainer = document.createElement("div");
    notificationContainer.classList.add("notification");
    notificationContainer.textContent = message;

    // Append the notification to the body
    document.body.appendChild(notificationContainer);

    // Remove the notification after a certain duration
    setTimeout(() => {
        document.body.removeChild(notificationContainer);
    }, 3000); // Adjust the duration as needed (e.g., 3000 milliseconds = 3 seconds)
}


        // Function to display sender emails in the chat list
function displaySenderEmails(senderEmails) {
    const chatList = document.getElementById("chatList");

    // Clear existing sender emails in the chat list
    chatList.innerHTML = "";

    senderEmails.forEach((senderEmail) => {
        const senderEmailElement = document.createElement("div");
        senderEmailElement.classList.add("sender-email");
        senderEmailElement.textContent = senderEmail;

        // Add click event listener to each sender email element
        senderEmailElement.addEventListener("click", function () {
            // Remove the "selected" class from all sender elements
            document.querySelectorAll(".sender-email").forEach((element) => {
                element.classList.remove("selected");
            });

            // Add the "selected" class to the clicked sender element
            senderEmailElement.classList.add("selected");

            // Display messages and job details when sender's email is clicked
            const receiverEmail = senderEmailElement.textContent;
            loadMessages(receiverEmail);
            fetchJobDetails(receiverEmail).then((jobDetails) => {
                displayJobDetails(jobDetails);
            });
        });

        chatList.appendChild(senderEmailElement);
    });
}
// Add this function to display sent messages
function displaySentMessages(sentMessages) {
    const messagesContainer = document.getElementById("messageContainer");

    sentMessages.forEach((message) => {
        const sentMessageContainer = document.createElement("div");
        sentMessageContainer.classList.add("message", "user-message");
        sentMessageContainer.innerHTML = `<p>Text: ${message.text}</p><p>Timestamp: ${getCurrentTimestamp()}</p>`;

        messagesContainer.appendChild(sentMessageContainer);
    });
}

// Update the fetchAndDisplaySentMessages function
async function fetchAndDisplaySentMessages() {
    try {
        const parsedData = JSON.parse(localStorage.getItem("formData"));

        if (!parsedData) {
            console.error("User data not found in local storage.");
            return;
        }

        const loggedInUserEmail = parsedData.email;

        const sentMessages = await fetchSentMessages(loggedInUserEmail);
        displaySentMessages(sentMessages);
    } catch (error) {
        console.error("Error fetching and displaying sent messages:", error);
    }
}

  </script>
    
</body>

</html>
